<!DOCTYPE html>
<html lang="en">
<head>
  <title>AnnifBot</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="static/css/bootstrap.min.css">
  <link rel="stylesheet" href="static/css/botui.min.css">
  <link rel="stylesheet" href="static/css/botui-theme-default.css">
  <script src="static/js/jquery.min.js"></script>
  <script src="static/js/bootstrap.min.js"></script>
  <script src="static/js/vue.min.js"></script>
  <script src="static/js/botui.js"></script>
  <style type="text/css">
    header { background-color: #3f9a88; }
    h1 { color: white; font-size: 2rem; }
    #chat h2 {
      background: white url(static/img/anni.png) no-repeat bottom left;
      background-size: 2.6rem 3.5rem;
      padding-left: 3rem;
      padding-top: 1.9rem;
      font-size: 1.5rem;
      height: 3.5rem;
      border-bottom: 1px solid #999999;
    }
    .botui-message-content-image {
      max-width: 300px;
      max-height: 300px;
    }
    #about {
      border: 1px solid #999999;
      border-radius: 0.5rem;
      padding: 1rem;
    }
    #about h2 {
      background: white url(static/img/anni.png) no-repeat bottom left;
      background-size: 2.1rem 2.8rem;
      padding-left: 2.3rem;
      padding-top: 1.5rem;
      font-size: 1.3rem;
      height: 2.8rem;
      border-bottom: 1px solid #999999;
    }
    #about p { font-size: 0.9rem; }
  </style>

<!-- Matomo -->
<script type="text/javascript">
  var _paq = _paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
  _paq.push(["setCookieDomain", "*.annif.org"]);
  _paq.push(["setDomains", ["*.annif.org","*.annif.org"]]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//analytics.finto.fi/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', '8']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//analytics.finto.fi/piwik.php?idsite=8&rec=1" style="border:0;" alt="" /></p></noscript>
<!-- End Matomo Code -->

</head>
<body>

<header class="mb-4 mt-0">
  <div class="container">
    <h1 class="py-3">AnnifBot
  </div>
</header>
  
<div class="container">

  <div class="row">
    <div class="col-md-8" id="chat">
      <h2>Anni F.</h2>
      <div id="my-botui-app">
        <bot-ui></bot-ui>
      </div>
    </div>
    <div class="col-md-4">
      <div id="about">
        <h2>About me</h2>
        <p>Hello there! I'm Anni and I'm a robot. I love books, old photographs, museum
        objects and other collections in libraries, archives and
        museums. I've studied millions of them, so I'm happy to recommend
        some for you!</p>
        
        <p>To be honest, I didn't really read all those books - I just
        skimmed the shelves, so to speak. My maker Osma calls it metadata
        analysis, natural language processing and machine learning, but to
        me it's just words, concepts and URIs. And APIs! I use the <a
        href="http://api.annif.org">Annif</a>, <a
        href="http://api.finna.fi">Finna</a> and <a
        href="http://api.finto.fi">Finto</a> APIs every time I chat. I'd be
        totally lost without them!</p>
        
        <p>If you don't believe me, check out the page source, or see <a
        href="https://github.com/NatLibFi/Annif/tree/website/bot">all my
        code</a> on GitHub!</p>
      </div>
    </div>
  </div>

</div>

  <script>

var annif_base_url = 'https://api.annif.org/v1/';
var finna_base_url = 'https://api.finna.fi/v1/';
var finna_image_url = 'https://api.finna.fi';
var finna_record_url = 'https://www.finna.fi/Record/'

var project = 'yso-fi';

function random_choice(arr) {
   return arr[Math.floor(Math.random()*arr.length)];
}

function suggest(text, callback) {
    $.ajax({
        url: annif_base_url + "projects/" + project + "/suggest",
        method: 'POST',
        data: { 
          text: text,
          limit: 3,
          threshold: 0.01
        },
        success: function(data) {
          if (data.results.length > 0) {
            callback(data.results);
          } else {
            botui.message.add({
              content: "En ihan ymmärtänyt. Mikä muu sinua voisi kiinnostaa?"
            }).then(get_subject);
          }
        }
    });
}


function random_picture(subject, callback) {
  var filters = ['format:0/Image/', 'online_boolean:1'];
  $.ajax({
    url: finna_base_url + "search",
    method: 'GET',
    data: {
      lookfor: subject,
      'filter[]': filters,
    },
    success: function(data) {
      if (data.hasOwnProperty('records') && data.records.length > 0) {
        pic = random_choice(data.records);
        callback(pic.title, pic.images[0], pic.id);
      } else {
        botui.message.add({
          content: "Voi harmi, en löytänytkään yhtään kuvaa. Mikä muu sinua voisi kiinnostaa?"
        }).then(get_subject);
      }
    }
  });
}

function random_book(subject, callback) {
  var filters = ['format:0/Book/'];
  $.ajax({
    url: finna_base_url + "search",
    method: 'GET',
    data: {
      lookfor: subject,
      type: 'Subject',
      'filter[]': filters,
    },
    success: function(data) {
      if (data.hasOwnProperty('records') && data.records.length > 0) {
        book = random_choice(data.records);
        console.log(book);
        callback(book.title, book.nonPresenterAuthors, book.images[0], book.id);
      } else {
        botui.message.add({
          content: "Voi harmi, en löytänytkään yhtään kirjaa. Mikä muu sinua voisi kiinnostaa?"
        }).then(get_subject);
      }
    }
  });
}

function ask_more(label) {
  $('html, body').animate({scrollTop:$(document).height()}, 'slow');
  botui.action.button({
    action: [
      { // show only one button
        text: 'Joo!',
        value: true
      },
      { // show only one button
        text: 'Ei',
        value: false
      }
    ]
  }).then(function (res) { // will be called when a button is clicked.
    if(res.value == true) {
      show_content(label);
    } else {
      botui.message.add({
        content: "Mikä muu sinua voisi kiinnostaa?"
      }).then(get_subject);
    }
  });
}


var botui = new BotUI('my-botui-app');


function show_pic(label) {
  botui.message.add({
    delay: 1000,
    content: 'Odotas, etsin sinulle kuvan!'
  }).then(function() {
    random_picture(label, function(title, url, recid) {
      var img_url = finna_image_url + url;
      var rec_url = finna_record_url + encodeURI(recid);
      $('html, body').animate({scrollTop:$(document).height()}, 'slow');
      botui.message.add({
        content: title + ' [![' + title + '](' + img_url + ')](' + rec_url + ')'
      }).then(function() {
        botui.message.add({
          delay: 500,
          content: "Haluatko lisää?"
        }).then(function() { ask_more(label); });
      });
    });
  });
}

function show_book(label) {
  botui.message.add({
    delay: 1000,
    content: 'Odotas, etsin sinulle kirjan!'
  }).then(function() {
    random_book(label, function(title, authors, url, recid) {
      var img_url = finna_image_url + url;
      var rec_url = finna_record_url + encodeURI(recid);
      $('html, body').animate({scrollTop:$(document).height()}, 'slow');
      if (authors.length > 0) {
        var author_string = authors.map(author => author.name).join('; ') +
        ":<br>\n";
      } else {
        var author_string = "";
      }
      botui.message.add({
        content: author_string + '[' + title + '](' + rec_url + ') [![' + title + '](' + img_url + ')](' + rec_url + ')'
      }).then(function() {
        botui.message.add({
          delay: 500,
          content: "Haluatko lisää?"
        }).then(function() { ask_more(label); });
      });
    });
  });
}

function show_content(label) {
  var show_functions = [show_pic, show_book];
  func = random_choice(show_functions);
  func(label);
}

function ask_subject(subjects) {
  label = subjects.shift().label;
  var msg = 'Kiinnostaako sinua ' + label + '?';
  botui.message.add({
    content: msg
  }).then(function() {
    $('html, body').animate({scrollTop:$(document).height()}, 'slow');
    botui.action.button({
      action: [
        { // show only one button
          text: 'Joo!',
          value: true
        },
        { // show only one button
          text: 'Ei',
          value: false
        }
      ]
    }).then(function (res) { // will be called when a button is clicked.
      if(res.value == true) {
        show_content(label);
      } else {
        if (subjects.length > 0) {
          ask_subject(subjects);
        } else {
          botui.message.add({
            content: "Mikä muu sinua voisi kiinnostaa?"
          }).then(get_subject);
        }
      }
    });
  });
}

function get_subject() {
  return botui.action.text({ // show 'text' action
    human: true, 
    action: {
      placeholder: ''
    }
  }).then(function (res) { // get the result
    suggest(res.value, function(results) {
      if(results.length > 0 &&
         results[0].label.toLowerCase() == res.value.toLowerCase()) {
        show_content(results[0].label); // shortcut
      } else {
        ask_subject(results);
      }
    });
  });
}


botui.message.add({
  content: 'Hei, olen Anni! Hauska tutustua!'
}).then(function(res) {
  return botui.message.add({
    content: 'Mikä sinua tänään kiinnostaa?',
  }).then(get_subject);
});
  </script>

</body>
</html>
